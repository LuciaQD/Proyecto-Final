---
title: "Siniestros de tránsito en Uruguay"
author: "Bruno Bellagamba y Lucía Quintero"
date: "Junio 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Introducción

El siguiente trabajo se enmarca dentro de la materia "Nuevas tecnologías para el análisis estadístico de datos" de la carrera Licenciatura en Estadística.  

El principal objetivo del mismo es aplicar las técnicas aprendidas en el curso para realizar el análisis exploratorio de los datos seleccionados, lo cuál también implica incluir visualizaciones apropiadas y una buena interpretación de las mismas.
Como objetivos adicionales se busca que el trabajo sea completamente reproducible y esté disponible en GitHub para colaboraciones futuras, y poder comunicar los principales resultados del mismo mediante una aplicación shiny.

Para alcanzar los objetivos planteados se utilizan diversas herramientas de R destacándose el uso del paquete *tidyverse*, en particular los paquetes *dplyr* y *ggplot*.
También cabe destacar el uso de *rmarkdown* para la realización del presente informe y el paquete *shiny* para realizarla aplicación con los principales resultados.

La metodología para realizar el análisis exploratorio consiste en realizar preguntas de interés y responderlas a través del uso de las herramientas anteriormente mencionadas.

## Datos

Los datos seleccionados para el presente trabajo corresponden a los siniestros de tránsito ocurridos en Uruguay en el período 2013-2017. Los mismos se obtuvieron de la página web de la UNASEV *(ver enlace en la sección Bibliografía)* Se selecciona esta base para trabajar ya que se considera un tema de interés a nivel nacional y sobre el cuál se trabaja continuamente con el fin de disminuir la cantidad de siniestros.

La base cuenta con 149.377 observaciones carrespondientes cada una a un siniestro de tránsito, y 10 variables que representan detalles de los mismos como el lugar, gravedad, fecha y hora y tipo de siniestro.
Para poder realizar un mejor análisis se agregaron las variables Año y Mes, totalizando 12 variables para trabajar.

A partir de una primera aproximación con los datos se observa que la mayoría de las variables son cualitativas (Calle, Tipo de siniestro, Gravedad, Día de la semana, Departamento, Localidad), y las restantes cuantitativas (Año, Mes, Hora, longitud, latitud). **VER SI ESTO ES ASí Y QUE PASA CON LA FECHA**. En principio no se detecta la presencia de datos faltantes, pero si de una observación con la descripción SIN DATO en la variable Tipo de siniestra, la cuál se decide sacar.

Para el análisis se decide trabajar con las variables Tipo de siniestro, Gravedad, Día de la semana, Departamento, Hora, Año y Mes. **Si nos da el tiempo incluimos latitud y longitud parael mapa en shiny, sino lo agregamos en comentarios finales como posible trabajo futuro**  

```{r, echo = FALSE, warning = FALSE, message = FALSE}
library(tidyverse)
library(lubridate)

#1 Subimos los archivos

Este_2013 <- read_csv("Siniestros/2013/Este_2013.txt")
Oeste_2013 <- read_csv("Siniestros/2013/Oeste_2013.txt")
Norte_2013 <- read_csv("Siniestros/2013/Norte_2013.txt")
Montevideo_2013 <- read_csv("Siniestros/2013/Montevideo_2013.txt")

Este_2014 <- read_csv("Siniestros/2014/Este_2014.txt")
Oeste_2014 <- read_csv("Siniestros/2014/Oeste_2014.txt")
Norte_2014 <- read_csv("Siniestros/2014/Norte_2014.txt")
Montevideo_2014 <- read_csv("Siniestros/2014/Montevideo_2014.txt")

Este_2015 <- read_csv("Siniestros/2015/Este_2015.txt")
Oeste_2015 <- read_csv("Siniestros/2015/Oeste_2015.txt")
Norte_2015 <- read_csv("Siniestros/2015/Norte_2015.txt")
Montevideo_2015 <- read_csv("Siniestros/2015/Montevideo_2015.txt")

Este_2016 <- read_csv("Siniestros/2016/Este_2016.txt")
Oeste_2016 <- read_csv("Siniestros/2016/Oeste_2016.txt")
Norte_2016 <- read_csv("Siniestros/2016/Norte_2016.txt")
Montevideo_2016 <- read_csv("Siniestros/2016/Montevideo_2016.txt")

Este_2017 <- read_csv("Siniestros/2017/Este_2017.txt")
Oeste_2017 <- read_csv("Siniestros/2017/Oeste_2017.txt")
Norte_2017 <- read_csv("Siniestros/2017/Norte_2017.txt")
Montevideo_2017 <- read_csv("Siniestros/2017/Montevideo_2017.txt")

#2 Armamos las bases por año

base2013 <- bind_rows(Este_2013, Oeste_2013, Norte_2013, Montevideo_2013)
base2014 <- bind_rows(Este_2014, Oeste_2014, Norte_2014, Montevideo_2014) 
base2015 <- bind_rows(Este_2015, Oeste_2015, Norte_2015, Montevideo_2015) 
base2016 <- bind_rows(Este_2016, Oeste_2016, Norte_2016, Montevideo_2016)  
base2017 <- bind_rows(Este_2017, Oeste_2017, Norte_2017,Montevideo_2017)

#3 Armamos la base de todos los años, cambiamos los nombres de las variables con espacio en el mismo y agregamos las variables Año y Mes 

datos <- as.data.frame(bind_rows(base2013, base2014, base2015, base2016, base2017)) %>% 
  rename_at(3, ~"Tipo_de_siniestro") %>%  
  rename_at(5, ~ "Dia_semana") %>%
  filter(Tipo_de_siniestro != 'SIN DATOS') %>%
  mutate(Año = year(as.Date(Fecha, "%d/%m/%Y")), Mes = month(as.Date(Fecha, "%d/%m/%Y")))


s <- summary(datos)

```

## Análisis Exploratorio

Comenzamos con un análisis temporal explorando los datos a través de los años y meses, incluyendo también los dias de la semana y hora de los siniestros.

En primer lugar nos planteamos cuantficar el número de siniestros en los diferentes años de análisis para luego realizar un gráfico de barras donde pretendemos ver la variación de los mismos.

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = cap1, fig.width = 6, fig.height = 4}

#Resumen de datos
r <- datos %>%
      group_by(Año) %>%
      summarise(Cantidad = n())

#Gráfico
r %>%
  ggplot(aes(x = Año, y = Cantidad)) + 
  geom_line(size = 1, color = "seagreen4") +
  labs(x = "Año", y = "Cantidad") +
  ggtitle("Siniestros por año") 

cap1 <- "A partir del gráfico podemos observar que del año 2013 al 2015 hubo un incremento sostenido en la cantidad de siniestros habiendo un descenso en el año 2016 para volver a crecer en el 2017. De todas formas no se observa una variación importante a lo largo del periodo."

```

Continuando con la exploración, vamos a ver si se puede visualizar alguna tendencia mensual en la cantidad de siniestros. Para esto realizamos un gráfico de los siniestros por mes para cada año.

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = cap2, fig.width = 6, fig.height = 4}

datos %>%
  group_by(Mes, Año) %>%
  summarize(n = n()) %>%
  ggplot(aes(Mes, n, color = factor(Año))) +
  geom_line(size = 1) +
  scale_x_continuous(breaks = seq(1,12,1), 
                     labels = c("Enero", "Febrero", "Marzo", "Abril","Mayo", "Junio", "Julio", "Agosto", "Setiembre", "Octubre", "Noviembre", "Diciembre")) +
  labs(x = "Mes", y = "Cantidad", color = "Año")

cap2 <- ""

```

Grafico por dia de la semana faceteado por año

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = cap3, fig.width = 6, fig.height = 4}

datos %>%
  mutate(Dia_semana = wday(Fecha, label = TRUE)) %>%
  group_by(Dia_semana, Año) %>%
  summarise(Cantidad = n()) %>%
  ggplot(aes(x = factor(Dia_semana), y = Cantidad)) + 
  geom_point(color = "seagreen4") + 
  facet_wrap(~ Año) +
  scale_x_discrete(labels = c("DOMINGO", "LUNES", "MARTES", "MIÉRCOLES", "JUEVES","VIERNES", "SÁBADO" )) +
  labs(x = "Día de la semana", y = "Cantidad")

cap3 <- ""

```


grafico por horas

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = cap4, fig.width = 6, fig.height = 4}

datos %>%
  ggplot(aes(x = Hora)) + 
  geom_bar() +
  scale_x_continuous(breaks = seq(0,23,1)) +
  labs(x = "Hora del siniestro", y = "Cantidad") +
  facet_wrap(~ Año)

cap4 <- ""

```




## Aplicaci?n Shiny

## Comentarios finales

## Bibliograf?a

- R for Data Science - Garrett Grolemund, Hadley Wickham (<http://r4ds.had.co.nz/>)  
- ggplot2 Elegant Graphics for Data Analysis - Hadley Wickham  
- Datos: P?gina web UNASEV (<http://aplicaciones.unasev.gub.uy/mapas/AdministracionMapaIndicadores/AdministracionMapaIndicadores_Alta>)

###Cosas para hacer
-Restar graficos irrelevantes
-Cambiar selectinput para año y variable(el filtro de año va afuera del if)
_Usar tags para comentarios
-Cambiar paleta de colores del mapa y cambiar la "variable" por la que contamos
-Grafico de series
-Extra:Generar mapa con puntos de concentracion