---
title: "Siniestros de tránsito en Uruguay"
author: "Bruno Bellagamba y Lucía Quintero"
date: "Junio 2018"
output: 
  pdf_document: default
  fig_caption: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy.opts = list(width.cutoff = 50), tidy = TRUE, fig.pos = 'h', out.extra = '')
```

## Introducción

El siguiente trabajo se enmarca dentro de la materia "Nuevas tecnologías para el análisis estadístico de datos" de la carrera Licenciatura en Estadística.  

Para el mismo se elige trabajar con los datos de los siniestros de tránsito ocurridos en Uruguay en el período 2013-2017 obtenidos de la página web de la Unidad Nacional de Seguridad Vial (UNASEV) dado que el tema representa una problemática actual para la cual se busca generar información de interés para entender mejor las características de la siniestralidad del país. 

El principal objetivo del trabajo es aplicar las técnicas aprendidas en el curso para realizar el análisis exploratorio de los datos seleccionados, lo cuál también implica incluir visualizaciones apropiadas y una buena interpretación de las mismas.
Como objetivos adicionales se busca que el trabajo sea completamente reproducible y esté disponible en GitHub para colaboraciones futuras, y poder comunicar los principales resultados del mismo mediante una aplicación shiny.

Para alcanzar los objetivos planteados se utilizan diversas herramientas de R destacándose el uso del paquete *tidyverse*, en particular los paquetes *dplyr* y *ggplot*.
También cabe destacar el uso de *rmarkdown* para la realización del presente informe y el paquete *shiny* para realizarla aplicación con los principales resultados.

La metodología para realizar el análisis exploratorio consiste en realizar preguntas de interés y responderlas a través del uso de las herramientas anteriormente mencionadas.

## Datos

Como se menciona en la sección anterior, los datos seleccionados corresponden a los siniestros de tránsito ocurridos en Uruguay en el período 2013-2017. Los mismos se obtuvieron de la página web de la UNASEV *(ver enlace en la sección Bibliografía)* 

La base cuenta con 149.377 observaciones carrespondientes cada una a un siniestro de tránsito, y 10 variables que representan detalles de los mismos como el lugar, gravedad, fecha y hora y tipo de siniestro.
Para poder realizar un mejor análisis se agregaron las variables Año y Mes, totalizando 12 variables para trabajar.

A partir de una primera aproximación con los datos se observa que la mayoría de las variables son cualitativas (Calle, Tipo de siniestro, Gravedad, Día de la semana, Departamento, Localidad), y las restantes cuantitativas (Año, Mes, Hora, longitud, latitud). En principio no se detecta la presencia de datos faltantes, pero si de una observación con la descripción "SIN DATOs" en la variable Tipo de siniestro, la cuál se decide sacar.

Para el análisis se decide trabajar con las variables Tipo de siniestro, Gravedad, Día de la semana, Departamento, Hora, Año y Mes. 

```{r, echo = FALSE, warning = FALSE, message = FALSE}
library(tidyverse)
library(lubridate)

#1 Subimos los archivos

Este_2013 <- read_csv("Siniestros/2013/Este_2013.txt")
Oeste_2013 <- read_csv("Siniestros/2013/Oeste_2013.txt")
Norte_2013 <- read_csv("Siniestros/2013/Norte_2013.txt")
Montevideo_2013 <- read_csv("Siniestros/2013/Montevideo_2013.txt")

Este_2014 <- read_csv("Siniestros/2014/Este_2014.txt")
Oeste_2014 <- read_csv("Siniestros/2014/Oeste_2014.txt")
Norte_2014 <- read_csv("Siniestros/2014/Norte_2014.txt")
Montevideo_2014 <- read_csv("Siniestros/2014/Montevideo_2014.txt")

Este_2015 <- read_csv("Siniestros/2015/Este_2015.txt")
Oeste_2015 <- read_csv("Siniestros/2015/Oeste_2015.txt")
Norte_2015 <- read_csv("Siniestros/2015/Norte_2015.txt")
Montevideo_2015 <- read_csv("Siniestros/2015/Montevideo_2015.txt")

Este_2016 <- read_csv("Siniestros/2016/Este_2016.txt")
Oeste_2016 <- read_csv("Siniestros/2016/Oeste_2016.txt")
Norte_2016 <- read_csv("Siniestros/2016/Norte_2016.txt")
Montevideo_2016 <- read_csv("Siniestros/2016/Montevideo_2016.txt")

Este_2017 <- read_csv("Siniestros/2017/Este_2017.txt")
Oeste_2017 <- read_csv("Siniestros/2017/Oeste_2017.txt")
Norte_2017 <- read_csv("Siniestros/2017/Norte_2017.txt")
Montevideo_2017 <- read_csv("Siniestros/2017/Montevideo_2017.txt")

#2 Armamos las bases por año

base2013 <- bind_rows(Este_2013, Oeste_2013, Norte_2013, Montevideo_2013)
base2014 <- bind_rows(Este_2014, Oeste_2014, Norte_2014, Montevideo_2014) 
base2015 <- bind_rows(Este_2015, Oeste_2015, Norte_2015, Montevideo_2015) 
base2016 <- bind_rows(Este_2016, Oeste_2016, Norte_2016, Montevideo_2016)  
base2017 <- bind_rows(Este_2017, Oeste_2017, Norte_2017,Montevideo_2017)

#3 Armamos la base de todos los años, cambiamos los nombres de las variables con espacio en el mismo y agregamos las variables Año y Mes 

datos <- as.data.frame(bind_rows(base2013, base2014, base2015, base2016, base2017)) %>% 
  rename_at(3, ~"Tipo_de_siniestro") %>%  
  rename_at(5, ~ "Dia_semana") %>%
  filter(Tipo_de_siniestro != 'SIN DATOS') %>%
  mutate(Año = year(as.Date(Fecha, "%d/%m/%Y")), Mes = month(as.Date(Fecha, "%d/%m/%Y")))


s <- summary(datos)

```

## Análisis Exploratorio

El análisis exploratorio intenta responder diversas preguntas que se generan a partir de la primera visualización de los datos, como por ejemplo:
- ¿Cómo varía la cantidad de siniestros a través de los años del período analizado?
- ¿Hay un "comportamiento" temporal para los siniestros, ya sea menusal, diario o por hora?
- ¿Qué relacion hay entre los tipos de siniestros y la gravedad de los mismos?
- A partir de la información por departamento, ¿podemos caracterizarlos?

Comenzamos con un análisis temporal explorando los datos a través de los años y meses, incluyendo también los días de la semana y hora de los siniestros.

En primer lugar nos planteamos cuantficar el número de siniestros en los diferentes años de análisis para luego realizar un gráfico donde pretendemos ver la variación de los mismos.

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = cap1, fig.width = 6, fig.height = 4}
library(ggpmisc)

#Resumen de datos
r <- datos %>%
      group_by(Año) %>%
      summarise(Cantidad = n())

#Gráfico
r %>%
  ggplot(aes(x = Año, y = Cantidad)) + 
  geom_line(size = 1, color = "seagreen4") +
  labs(x = "Año", y = "Cantidad") +
  ggtitle("Siniestros por año") +
  theme(plot.title = element_text(size = rel(1.5)), axis.title = element_text(face = "bold"))

##agregar etiquetas con el valor maximo y minimo

cap1 <- "A partir del gráfico podemos observar que del año 2013 al 2015 hubo un incremento sostenido en la cantidad de siniestros habiendo un descenso en el año 2016 para volver a crecer en el 2017, aunque por debajo de los años 2014 y 2015. De todas formas no se observa una variación importante a lo largo del período."

```

Continuando con la exploración, queremos ver si hay alguna tendencia mensual en la cantidad de siniestros. Para esto realizamos un gráfico de los siniestros por mes para cada año.

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = cap2, fig.width = 6, fig.height = 4}

datos %>%
  group_by(Mes, Año) %>%
  summarize(n = n()) %>%
  ggplot(aes(Mes, n, color = factor(Año))) +
  geom_line(size = 1) +
  scale_color_brewer(palette = "Dark2") +
  scale_x_continuous(breaks = seq(1,12,1), 
                     labels = c("Ene", "Feb", "Mar", "Abr","May", "Jun", "Jul", "Ago", "Set", "Oct", "Nov", "Dic")) +
  theme(legend.position = "bottom", plot.title = element_text(size = rel(1.5)), axis.title = element_text(face = "bold")) +
  labs(x = "Mes", y = "Cantidad", color = "Año") +
  ggtitle("Siniestros por mes")

cap2 <- "Se puede observar un comportamiento bastante regular en los meses de los diferentes años. Hay dos picos claros en los meses
de marzo y diciembre los cuales coinciden con semana de turismo y fin de año respectivamente, algo que es razonable ya que son momentos donde aumenta el movimiento vehicular. "

```

Ahora vamos a ver si hay un comportamiento semanal, para esto en primer lugar vamos a graficar los siniestros por día de la semana para cada año y luego para cada mes (acumulado de los 5 años).

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = cap3, fig.width = 6, fig.height = 4}

datos %>%
  mutate(Dia_semana = wday(as.Date(Fecha, "%d/%m/%Y"), label = TRUE)) %>%
  ggplot(aes(x = Dia_semana)) + 
    geom_bar(fill = "seagreen4") + 
    scale_x_discrete(labels = c("DOM", "LUN", "MAR", "MIÉ", "JUE","VIE", "SÁB" )) +
    labs(x = "Día de la semana", y = "Cantidad") + 
    ggtitle("Siniestros por día de la semana (anual)") +
    facet_wrap(~ Año) +
    theme(plot.title = element_text(size = rel(1.5)), axis.title =  element_text(face = "bold"))

cap3 <- "Se observa un incremento en los siniesros los días lunes, viernes y sábados siendo estables el resto de los días. Esto parece concordar con el mayor movimiento que se de los fines de semana. "

```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = cap4, fig.width = 6, fig.height = 4}

datos %>%
  mutate(Dia_semana = wday(as.Date(Fecha, "%d/%m/%Y"), label = TRUE)) %>%
  ggplot(aes(x = Dia_semana)) + 
    geom_bar(fill = "seagreen4") + 
    scale_x_discrete(labels = c("DOM", "LUN", "MAR", "MIÉ", "JUE","VIE", "SÁB" )) +
    labs(x = "Día de la semana", y = "Cantidad") + 
    ggtitle("Siniestros por día de la semana (mensual)") +
    facet_wrap(~ Mes) +
    theme(plot.title = element_text(size = rel(1.5)), axis.title = element_text(face = "bold"))


###cambiar las etiquetas de los meses!!

cap4 <- "En el gráfico por mes vemos el mismo comportamiento que en el gráfico anual, los lunes,viernes y sábados se ve un aumento en los sinietros. Tambien visualizamos el aumento que hay en diciembre en los siniestros en general."

```

Siguiendo con el análisis, vamos a ver que sucede con la hora de los siniestro graficando la cantidad de siniestros por hora para cada año y luego por día de la semana. 

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = cap5}

datos %>%
  ggplot(aes(x = Hora)) + 
  geom_bar(fill = "seagreen4") +
  scale_x_continuous(breaks = seq(0,23,1)) +
  labs(x = "Hora del siniestro", y = "Cantidad") +
  facet_wrap(~ Año) + 
  ggtitle("Siniestros por hora (anual)") +
  theme(plot.title = element_text(size = rel(1.5)), axis.title = element_text(face = "bold"))


##ver si podemos mejorar el eje de las horas

cap5 <- "A partir de los gráficos se observa que el comportamiento es muy similar en todos los años siendo el horario de 17 a 19 horas el que presenta mayor cantidad de siniestros."

```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = cap6}

datos %>%
  mutate(Dia_semana = wday(as.Date(Fecha, "%d/%m/%Y"), label = TRUE)) %>%
  ggplot(aes(x = Hora)) + 
  geom_bar(fill = "seagreen4") +
  scale_x_continuous(breaks = seq(0,23,1)) +
  labs(x = "Hora del siniestro", y = "Cantidad") +
  facet_wrap(~ Dia_semana) +
  ggtitle("Siniestros por hora (semanal)") +
  theme(plot.title = element_text(size = rel(1.5)), axis.title = element_text(face = "bold"))

## etiquetasde los dias en el facet y ver si podemos mejorar el eje de las horas

cap6 <- "Observamos que el comportamiento es similar en todos los días de la semana viendo al igual que en el gráfico por años que el horarios de 17 a 19 horas es donde ocurrieron la mayor cantidad de siniestros."

```

**A partir del análisis realizado hasta el momento con las variables temporales podemos decir que el año con mayor cantidad de siniestros fue el 2015 con un total de 31.048, mientras que 2016 fue el de menor cantidad con 28.596 siniestros. De estos datos decimos que la diferencia entre el número máximo de accidentes registrados y el mínimo es de 2.452. SEGUIR CON UN RESUMEN DE LAS PRINCIPALES CONCLUSIONES DEL ANÁLISIS TEMPORAL**


**Introduccion al nuevo análisis, a los gráficos, agregar comentarios, mejorar los graficos y concluir. Lo mismo para el análisis departamental**
Analisis por tipo de siniestro y gravedad de los mismos, vamos a cruzar estas variables y luego vamos a verlas con el factor temporal

Continuando,evaluaremos si existe diferencias entre la cantidad de accidentes segun tipos de siniestros en los distintos años.

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = cap7, fig.width = 6, fig.height = 4}

datos %>%
  ggplot(aes(x = fct_infreq(Tipo_de_siniestro))) + 
  geom_bar(fill = "seagreen4") +
  coord_flip() +
  facet_wrap(~ Año) +
  labs(x = "Tipo de siniestro", y = "Cantidad") +
  ggtitle("Tipo de siniestros")

cap7 <- "No se observa una diferencia significativa en las cantidades de siniestros de cada tipo segun los años, parece constante.En cada año las colisiones entre vehiculos son los  tipo de siniestro mas frecuentes."

```

De manera analoga,como es relevante considerar las posibles diferencias en cantidad de siniestros segun gravedad para cadaaño, graficaremos como fueron estas cantidades. 
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = cap8, fig.width = 6, fig.height = 4}

datos %>%
  ggplot(aes(x = Gravedad)) + 
  geom_bar(fill = "seagreen4") +
  facet_wrap(~ Año) +
  labs(x = "Gravedad del siniestro", y = "Cantidad") +
  ggtitle("Gravedad de los siniestros")

cap8 <- "Se puede observar que a lo largo de los años, las cantidades de siniestros fatales y graves se han mantenido casi constantes mientras que los siniestros con gravedad leve han disminuido y aumentado el numero de accidentes sin lesionados aunque levemente."

```

Debido a que no todo tipo de siniestros tienen como resultado los mismos niveles de gravedad en los accidentados, una visualizacion de como estas dos variables se distribuyen conjuntamente puede ser algo util para captar este efecto.
Ademas los separaremos por año, por si esta estructura a la vez cambia segun el año.

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = cap9, fig.width = 6, fig.height = 4}

datos %>%
  ggplot(aes(x = Tipo_de_siniestro, fill = Gravedad)) + 
  geom_bar(position = "fill") + 
  coord_flip() +
  facet_wrap(~Año) +
  theme(legend.position = "bottom") +
  labs(x = "Tipo de siniestro", y = "Fracuencia") +
  ggtitle("Gravedad por tipo de siniestro")

cap9 <- "Como era esperable, los accidentes con menor proporcion de no lesionados son los correspondientes a los atropellos de peaton siendo estos los tipos de siniestros con mas cantidad de resultados fatales.Algo quizas no tan esperado fuera que las colisiones con obstaculos tengan la mayor proporcion de selutados sin lesionados."

```

Si bien vimos anteriormente que los dias de la semana no afectan en la cantidad de accidentes, quizas podrian estar afectando otra variable como la gravedad del siniestro.
Asi que consideramos graficar como se distribuye la gravedad de los accidentes segun el dia de la semana.
```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.cap = cap10, fig.width = 6, fig.height = 4}

datos %>%
  mutate(Dia_semana = wday(Fecha, label = TRUE)) %>%
  ggplot(aes(x = factor(Dia_semana), fill = Gravedad)) + 
  geom_bar(position = "fill") + 
  facet_wrap(~Año) +
  theme(legend.position = "bottom") +
  scale_x_discrete(labels = c("DOMINGO", "LUNES", "MARTES", "MIÉRCOLES", "JUEVES","VIERNES", "SÁBADO" )) +
  labs(x = "Día de la semana", y = "Cantidad") +
  ggtitle("Gravedad por día de la semana")

cap10 <- "No hay una relacion entre el dia de la semana y la gravedad del accidente"

```
 Análisis por departamento.
 
 Cantidad de siniestros por departamento
 
 Tipo de siniestro por departamento
 
 Gravedad por departamento
 
 Hacemos algo temporal por  departamento?


## Aplicación Shiny
En la aplicacion Shiny realizada, continuamos mas a fondo con este analisis exploratorio inicial, considerando analisis de variables individuales asi como variables cruzadas pudiendo enfocar el grafico en cualquier año deseado.
Ademas, incluimos una distribucion geografica de los siniestros segun varias categorias en el al mapa de Uruguay donde se veran las diferencias de cantidad de siniestro segun departamenro.




## Comentarios finales

A partir de los analisis realizados podemos extraer algunas conclusiones :
-El efecto anual en la cantidad de siniestros no parece aplicarse, pero si se observa una variacion en la gravedad de los accidentes a lo largo de los años, presentando una mejoria.(menos accidentes graves y mas sin lesionados)
-La distribucion semanal no tiene un efecto en la cantidad de accidentes pero la mensual si la tiene, dandose la mayor cantidad de accidentes los meses de marzo y diciembre.
-Tambien hay una distribucion interesante de los accidentes por hora, dandose el pico en las horas 17 y 18 independientemente del dia de la semana, mes o año.
-Geograficamente, si bien es evidente que en Montevideo se dieran la mayor cantidad de accidentes, el mayor ratio de siniestros cada 100 habitantes se da en Paisandú. Tambien se pueden observar las diferencias en el ratio de accidentes segun el tipo de siniestro y su gravedad destacando por ejemplo que San Jose tiene el mayor ratio de accidentes fatales en el pais o que en Paisandu se producen la mayor cantidad de colisiones entre vehiculos por cada 100 habitantes.


Asi tambien, hay que señalar posibles agregados y continuaciones que se le pueden adjuntar a este trabajo.
Como principal continuacion, se buscaria poder modelar y predecir los siniestros de años futuros utilizando modelacion segun series temporales.Asi como esto, tambien el poder luego contrastar y evaluar los modelos propuestos con los resultados publicados a futuro.
Tambien se podria agregar una distribucion geografica mas prescisa al analisis, llegando al punto de identificacion exacta de donde ocurrio el accidente basandose en coordenadas y las calles de ocurrencia.


**Si nos da el tiempo incluimos latitud y longitud parael mapa en shiny, sino lo agregamos en comentarios finales como posible trabajo futuro**  


## Bibliografía

- R for Data Science - Garrett Grolemund, Hadley Wickham (<http://r4ds.had.co.nz/>)  
- ggplot2 Elegant Graphics for Data Analysis - Hadley Wickham  
- Datos: Página web UNASEV (<http://aplicaciones.unasev.gub.uy/mapas/AdministracionMapaIndicadores/AdministracionMapaIndicadores_Alta>)


